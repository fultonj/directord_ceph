id: ssh_user
type: service
version: 1.0.0
tasks:
  - id: useradd
    action: useradd
    driver: directord
    provides:
      - ssh_user.useradd
    requires:
      - config.init
    jobs:
      - RUN: if ! id {{ ssh_username }}; then useradd {{ ssh_username }}; fi
      - RUN: echo "{{ ssh_username }} ALL=(root) NOPASSWD:ALL" | tee /etc/sudoers.d/{{ ssh_username }}
        vars:
          chmod: "0440"

  - id: sshdir
    action: sshdir
    driver: directord
    provides:
      - ssh_user.sshdir
    requires:
      - ssh_user.useradd
    jobs:
      - RUN: if [[ ! -d /home/{{ ssh_username }}/.ssh ]]; then mkdir -m 700 /home/{{ ssh_username }}/.ssh; fi
      - RUN: chown {{ ssh_username }}:{{ ssh_username }} /home/{{ ssh_username }}/.ssh
      - RUN: chcon system_u:object_r:ssh_home_t:s0 /home/{{ ssh_username }}/.ssh
      - ADD: >
          --blueprint files/ssh_user/ssh_config.j2 "/home/{{ ssh_username }}/.ssh/config"
          --chmod 0600
      - RUN: chown {{ ssh_username }}:{{ ssh_username }} /home/{{ ssh_username }}/.ssh/config

  - id: keygen
    action: keygen
    driver: directord
    provides:
      - ssh_user.keygen
    requires:
      - ssh_user.sshdir
    jobs:
      - RUN: >-
          --run-once
          export KEY=/home/{{ ssh_username }}/.ssh/id_ed25519 ;
          if [[ ! -e $KEY ]]; then ssh-keygen -q -t ed25519 -N "" -f $KEY; fi &&
          if [[ ! -e ${KEY}.pub ]]; then ssh-keygen -y -f $KEY > ${KEY}.pub; fi &&
          chown {{ ssh_username }}:{{ ssh_username }} $KEY ${KEY}.pub
      - RUN: >-
          --run-once
          --stdout-arg ssh_username_ssh_public_key_base64
          base64 -w 0 /home/{{ ssh_username }}/.ssh/id_ed25519.pub
      - QUERY: ssh_username_ssh_public_key_base64
      - RUN: >-
          --run-once
          --stdout-arg ssh_username_ssh_private_key_base64
          base64 -w 0 /home/{{ ssh_username }}/.ssh/id_ed25519
      - QUERY: ssh_username_ssh_private_key_base64

  - id: distrib
    action: distrib
    driver: directord
    provides:
      - ssh_user.distrib
    requires:
      - ssh_user.keygen
    jobs:
      - RUN: >-
          if ! test -f /home/{{ ssh_username }}/.ssh/id_ed25519.pub; then
              echo "{{ query.values() | map(attribute='ssh_username_ssh_public_key_base64') | select('defined') | reject('==', None) | list | first }}" | base64 -d > /home/{{ ssh_username }}/.ssh/id_ed25519.pub;
          fi;
      - RUN: >-
          if ! test -f /home/{{ ssh_username }}/.ssh/id_ed25519; then
              echo "{{ query.values() | map(attribute='ssh_username_ssh_private_key_base64') | select('defined') | reject('==', None) | list | first }}" | base64 -d > /home/{{ ssh_username }}/.ssh/id_ed25519;
          fi;

      - RUN: cp -p /home/{{ ssh_username }}/.ssh/id_ed25519.pub /home/{{ ssh_username }}/.ssh/authorized_keys
      - RUN: chown {{ ssh_username }}:{{ ssh_username }} /home/{{ ssh_username }}/.ssh/*
      - RUN: chcon unconfined_u:object_r:ssh_home_t:s0 /home/{{ ssh_username }}/.ssh/*
